pipeline {
    agent any

    stages {
        stage('Pull latest image from Docker Hub') {
            steps {
                sh '''
                    docker pull nourheneayari/eventsproject:latest
                    docker pull mysql:8.0
                '''
            }
        }

        stage('Stop & remove old stack (if exists)') {
            steps {
                sh '''
                    docker-compose -f docker-compose.yml down -v || true
                    docker volume rm eventsproject_mysql-data || true 2>/dev/null || true
                '''
            }
        }

        stage('Start app + MySQL with docker-compose') {
            steps {
                sh 'docker-compose up -d'
            }
        }

        stage('Wait for app to be healthy') {
            steps {
                timeout(120) {
                    waitUntil {
                        script {
                            def status = sh script: 'curl -s -o /dev/null -w "%{http_code}" http://localhost:8089/actuator/health || true', returnStdout: true
                            return status.trim() == "200"
                        }
                    }
                }
                echo "Application UP : http://$(hostname -I | awk '{print $1}'):8089"
            }
        }
    }

    post {
        always {
            echo "Stack déployée avec succès !"
            echo "→ API        : http://$(hostname -I | awk '{print $1}'):8089"
            echo "→ MySQL      : port 3306 (user: eventsuser / pass: events123)"
            echo "→ phpMyAdmin : http://$(hostname -I | awk '{print $1}'):8081 (optionnel)"
        }
    }
}
